---
title: CoAP与MQTT协议辨析
tags:
  - 物联网
categories:
  - 物联网
thumbnail: https://piccdn.freejishu.com/images/2019/04/19/PnxL0Z.jpg
abbrlink: 983c576
date: 2019-04-15 16:21:39
---
*这是六等星的小宇宙的第 11 篇文章  
写作时间 : 6小时  
总字数 : 5355字    
预计阅读时间 : 11分钟*

### 什么是CoAP与MQTT协议？
MQTT与CoAP都是为资源受限型的设备而设计的通信协议，在物联网领域有着广泛的应用。  

#### 什么是CoAP协议？
CoAP（Constrained Application Protocol）是一种应用于物联网领域的类WEB协议，CoAP直译为“受限应用协议”。顾名思义，CoAP协议一般用于资源受限的物联网设备上，在这类设备上的ram，rom通常都非常小，TCP/HTTP对于这类设备就显得过于庞大而不适用。

###### CoAP协议特点
- CoAP协议的网络传输层由TCP改为UDP
- CoAP基于REST
- 格式是二进制格式
- 协议轻量化，最小长度仅为4b，仅为HTTP头文件大小的十分之一左右
- 支持可靠传输，数据重传，块传输
- 支持IP多播
- 非长连接通信，适用于低功耗物联网场景

###### CoAP协议的四种消息类型
- CON  
需要被确认的请求。如CON请求被发送，则接收方必须做出响应。CoAP以此实现**可靠**响应。
- NON  
不需要被确认的请求。如NON请求被发送，接收方不必对请求作出响应。适用于消息会频繁重复被发送且丢包不影响正常操作的情况。在NON基础上的请求服务为**不可靠**消息传输。
- ACK  
ACK为对于CON所做出的消息应答
- RST  
RST为复位消息，在**可靠传输**时接收到无法解析的消息或错误时，必须回应RST消息。

##### CoAP的标准格式
![CoAP标准格式](https://piccdn.freejishu.com/images/2019/04/21/Pnxjsj.jpg)  

CoAP消息由四部分组成，分别为消息头（必选），Token（可选），Options（可选），Payload（可选）。
- 消息头（HEAD）  
CoAP第一行必为消息头，固定格式，大小为4个byte。分别为
   - Ver ： 2bit，版本信息
   - T ： 2bit，消息类型（四种）
   - TKL ： 4bit，token长度 当前支持0-8B长度，留有拓展空间
   - Code ： 8bit，分为前3bit，代表类型，后5bit，代表空消息或请求码
   - Message ID ： 16bit，代表消息MID，每个消息都有独立的ID辨识符，重复发送ID不变

- CoAP请求码（requests）与响应码（responses）  
   - 01 GET——用于获取资源
   - 02 POST——用于创建资源
   - 03 PUT——用于更新资源
   - 04 DELETE——用于删除资源

- token（可选）  
请求ID。用于异步通讯时匹配回应对象。在服务器无法实时响应客户端请求时，客户端就需要根据服务器发送消息的token来确定服务器消息时针对那个请求的。

- option（可选，0个或多个）  
用于描述请求或响应对应的各个属性，类似于参数或特征描述。

- payload（可选）  
实际携带的数据内容，若有，则需在数据内容前加上标志OxFF

###### CoAP的安全性  
CoAP的安全性是由DTLS加密实现。DTLS实现需要资源与带宽，在资源非常稀少的终端与有限的带宽下极有可能跑不起来。且DTLS仅适用于单播。

#### 什么是MQTT？  
在MQTT官网上是这样说的
>MQTT is a machine-to-machine (M2M)/"Internet of Things" connectivity protocol.  

“MQTT是一个 设备与设备（M2M）/ 物联网 之间的通信协议 ”  

参考链接   
[MQTT官方文档](http://mqtt.org/)   
[MQTT中文文档](https://legacy.gitbook.com/book/mcxiaoke/mqtt-cn)

##### MQTT设计规范
因为物联网环境相对特殊，所以MQTT遵循以下设计原则 ：
- 精简，不添加可有可无的功能
- 发布/订阅（Pub/Sub）模式，方便消息在传感器间传递
- 允许用户动态创建主题，零运维成本
- 最小化的传输量带来最大化的传输速率
- 考虑最坏情况（低带宽，高延迟，不稳定）
- 支持连续会话控制
- 理解客户端计算力可能很低
- 提供服务质量管理
- 假设数据不可知，不强求传输数据的类型与格式，保证灵活性

##### MQTT主要特性
- 使用**发布/订阅**消息模式，提供一对多消息发布，解除应用程序耦合
- 对负载内容屏蔽的消息传输
- 使用TCP/IP提供网络连接（提供MQTT-SN实现基于UDP的网络连接）
- **三种** 消息发布服务质量
   - 至多一次  
   消息发布完全依赖底层TCP/IP。可能发生消息丢失与重复。适用于会频繁重复发送的数据，丢包不影响正常运行的情况。
   - 至少一次  
    确保消息一定送达。可能发生消息重复。  
   - 只有一次  
   确保消息送达且只到达一次。主要用于对数据较为严格的系统中，例如计费系统。如消息重复或丢失都会导致较为严重的结果，对消息质量要求极高的情况下选用此消息发布服务质量。
- 小型传输，开销极小，协议交换最小化，降低网络传输成本  
是被用于IoT的核心原因，是在嵌入式设备运算能力与带宽都非常薄弱的情况下最合适的协议之一
- Last Will与Testament特性  
Last Will : 遗言机制，用于通知同一主题下的其他设备发送遗言的设备已断开连接
Testament ： 遗嘱机制，类似于Last Will

##### MQTT协议原理
###### MQTT协议实现方式
实现MQTT协议需要客户端与服务端通讯完成。通讯过程中，MQTT协议有三种身份：
- 发布者（Publish）
- 代理（Broker）（服务器）
- 订阅者（SubScribe）  
其中，消息的发布者与订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

MQTT传输的消息分别为
- 主题（Topic） 可以理解为消息的类型，订阅者订阅（Subscribe）后可以收到对应主题的消息内容（payload）
- 负载（payload） 可以理解为消息内容，指订阅者具体要使用的内容

##### 网络传输与应用消息
MQTT会构建底层的网络传输，它将建立客户端与服务端的连接，提供二者之间的一个有序的，无损的，基于字节流的双向传输。  
即应用数据通过MQTT网络发送时，MQTT会把与之相关的服务质量（QoS）与主题名（Topic）相关联。

##### MQTT客户端
一个使用MQTT协议的应用或设备，总是建立到服务器的网络连接，服务端可以：
- 发布其他客户端可能会订阅的消息
- 订阅其他客户的发布的消息
- 退订或删除应用程序的消息
- 断开与服务器连接

##### MQTT服务器
MQTT服务器被称为“消息代理”（Broker），可以使一个应用程序或一台设备，位于消息发布者与订阅者之间，服务器可以：
- 接受来自客户端的网络连接
- 接受客户发布的应用信息
- 处理来自客户端的订阅与退订请求
- 向订阅的客户端转发应用程序消息

##### MQTT协议的订阅、会话、主题
- 订阅（Subscription）  
订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的么个订阅都有一个不同的主题筛选器。
- 会话（Session）  
每个客户端与服务端建立连接后就是一个会话，客户端与服务器之间有状态交互，会话存在于一个网络之间，也可能在客户端与服务器之间跨越多个连续的网络连接。
- 主题名（Topic Name）  
连接到每一个应用程序消息的标签，与服务器订阅相匹配。服务器会将消息发送给订阅所匹配标签的每一个客户端。
- 主题筛选器（Topic Filter）  
一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。
- 负载（Payload）  
消息订阅者所接收的具体内容

##### MQTT协议中的方法
MQTT在协议中定义了一些方法，用来表示对确定资源所进行的操作。这个资源可以代表与现存在的数据或动态生成数据，主要取决于服务器的实现。通常来说，资源指服务器上的文件或输出。主要方法有：  
- Connect 等待与服务器建立连接
- Disconnect 等待MQTT客户端完成所做的工作，并与服务器断开TCP/IP会话
- Subscribe 等待完成订阅
- UnSubscribe 等待服务器取消客户端的一个或多个topics订阅
- Publish MQTT客户端发送消息请求，发送完成后返回应用线程

##### MQTT协议数据包标准结构
一个MQTT数据包由三部分组成，分别为固定头（Fixed header）、可变头（Variable header）、消息体（payload）。
- 固定头（必选）  
存在于所有MQTT数据表中，表示数据包类型以及数据表分组标识。结构如下
   - 数据包类型 ： Byte 1 中 bits 7 - 4，相当于一个四位无符号值。
   - 标识位 ： Byte1 中 bits 3 - 0  
   在不使用标识位的消息类型中，标识位作为保留位。收到无效标志时，接收端必须关闭网络连接。
      - UDP ： 发送消息的副本，用于保证消息的可靠传输，如果设置为1，则下面的变长长度中增加MessageId，并需要回复确认以保证消息传输完成，但不能用于检测消息的重复发送。
      - QoS ： 发布消息的服务质量，为最多一次（00），至少一次（01），只有一次（10），预留（11）
      - RETAIN ： 发布保留标识，代表服务器保留此次推送消息，若有新订阅者出现，就将消息推送给它，如没有则推送至当前订阅者够释放。
   - 剩余长度  Byte2  
   固定头的第二字节用于保存变长头部与消息体总大小，为可拓展机制，前7位用于保存长度，后部用于标识，若最后一位为1，表示长度不足，需使用第二字节继续保存。

- 可变头（可选）  
可选项，由数据包类型决定可变头是否存在与其具体消息内容，位于固定头与负载之间，常用于包的标识符
包PUBLISH (QoS > 0)、PUBACK、PUBREC、PUBREL、PUBCOMP、SUBSCRIBE、SUBACK、UNSUBSCRIBE、UNSUBACK都包含有2字节的数据包标识字段

- 消息体（可选）  
客户端收到的具体内容，包含CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE四种类型的消息。
- CONNECT，消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码
- SUBSCRIBE，消息体内容是一系列的要订阅的主题以及QoS
- SUBACK，消息体内容是服务器对于SUBSCRIBE所申请的主题及QoS进行确认和回复
- UNSUBSCRIBE，消息体内容是要订阅的主题



#### MQTT与CoAP的异同？
MQTT与CoAP均为Iot的常用协议，因为二者
- 开放标准
- 适用于受限环境（相比于HTTP）
- 支持异步传输
- 有多种实现

再来看二者的差异  
首先，MQTT与CoAP并没有好与不好的问题，只有适用场景的区别

**MQTT**  
MQTT的特点是可以保持**长连接**，并具备一定的实时性，云端向设备发送消息，设备可以在最短的时间收到并作出响应，所以MQTT更适用于需要实时控制的情况。为了保持长连接，MQTT设备需要不断发送心跳包，功耗就不会低，对功耗有严格要求的情况就不适合MQTT了。   
MQTT为物联网提供了许多体贴的设计，例如QoS，“遗言”设计。

**CoAP**
CoAP的特点就是**功耗低**，只用在发送数据时唤醒即可，发送完数据立即休眠。所以CoAP更适合纯粹的传感器设备，尤其是电池供电的传感器设备。
同时，  
CoAP基于UDP协议，对硬件的要求低于MQTT依赖的TCP协议。  
做反控设备时，基于TCP的MQTT比基于UDP的CoAP可靠。在使用蜂窝（3G，4G）数据时，CoAP反控极不稳定，甚至无法连通。  
在保证数据可靠的前提下，MQTT异步Pub/Sub实现优于CoAP必须等待对方应答才能返回的同步模式。


协议|核心特点|下层协议|适用场合|硬件要求
:-:|:-:|:-:|:-:|:-:|:
MQTT|长连接|TCP|实时控制/执行器|较高
CoAP|功耗低|UDP|数据采集/传感器|较低
